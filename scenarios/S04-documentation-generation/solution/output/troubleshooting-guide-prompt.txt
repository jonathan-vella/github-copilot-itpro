# Generate Troubleshooting Guide

Please create a comprehensive **Troubleshooting Guide** for the following Azure resources in resource group **rg-contoso-patient-portal-dev**:

## Deployed Resources

### Microsoft.Network/networkSecurityGroups (3 instance(s))
- **nsg-data-dev-qkfwso** (Location: swedencentral)
- **nsg-web-dev-qkfwso** (Location: swedencentral)
- **vnet-contosopat-dev-qkfwso-snet-privateendpoints-dev-nsg-swedencentral** (Location: swedencentral)

### Microsoft.Network/networkInterfaces (2 instance(s))
- **pe-sqlserver-dev-qkfwso.nic.2452ca69-7f5e-4505-b393-c8087fa23188** (Location: swedencentral)
- **pe-keyvault-dev-qkfwso.nic.caf77a4e-ae78-4d34-89d4-17f3838ecd40** (Location: swedencentral)

### Microsoft.Network/privateDnsZones (2 instance(s))
- **privatelink.database.windows.net** (Location: global)
- **privatelink.vaultcore.azure.net** (Location: global)

### Microsoft.Network/privateDnsZones/virtualNetworkLinks (2 instance(s))
- **privatelink.database.windows.net/link-to-vnet** (Location: global)
- **privatelink.vaultcore.azure.net/link-to-vnet** (Location: global)

### Microsoft.Network/privateEndpoints (2 instance(s))
- **pe-keyvault-dev-qkfwso** (Location: swedencentral)
- **pe-sqlserver-dev-qkfwso** (Location: swedencentral)

### Microsoft.Sql/servers/databases (2 instance(s))
- **sql-contosopat-dev-qkfwso/master** (Location: swedencentral)
- **sql-contosopat-dev-qkfwso/sqldb-patients-dev-qkfwso** (Location: swedencentral)

### microsoft.alertsmanagement/smartDetectorAlertRules (1 instance(s))
- **Failure Anomalies - appi-contosopa-dev-qkfwso** (Location: global)

### Microsoft.Insights/components (1 instance(s))
- **appi-contosopa-dev-qkfwso** (Location: swedencentral)

### Microsoft.KeyVault/vaults (1 instance(s))
- **kv-contosop-dev-qkfwso** (Location: swedencentral)

### Microsoft.Network/virtualNetworks (1 instance(s))
- **vnet-contosopat-dev-qkfwso** (Location: swedencentral)

### Microsoft.OperationalInsights/workspaces (1 instance(s))
- **log-contosopat-dev-qkfwso** (Location: swedencentral)

### Microsoft.Sql/servers (1 instance(s))
- **sql-contosopat-dev-qkfwso** (Location: swedencentral)

### Microsoft.Web/serverFarms (1 instance(s))
- **asp-contosopat-dev-qkfwso** (Location: swedencentral)

### Microsoft.Web/sites (1 instance(s))
- **app-contosopat-dev-qkfwso** (Location: swedencentral)


## Troubleshooting Guide Requirements

### 1. Common Issues by Resource Type

For each resource type listed above, document the most common issues:

#### Issue Template (repeat for each common issue):

**Issue Name**: [Brief, descriptive name]

**Symptoms**:
- Observable behaviors or error messages
- User-reported issues
- Metrics that indicate this problem

**Potential Causes**:
- Most likely root causes
- Common misconfigurations
- Known bugs or limitations

**Diagnostic Steps**:
1. Specific Azure CLI commands to run
2. KQL queries for Log Analytics/App Insights
3. Azure Portal locations to check
4. Metrics to review

Example diagnostic commands:
``bash
# Check resource health
az resource show --ids <resource-id> --query properties.provisioningState
``n
Example KQL query:
``kql
AzureDiagnostics
| where TimeGenerated > ago(1h)
| where Category == 'Error'
| summarize count() by Resource
``n
**Resolution Steps**:
1. Step-by-step fix procedure
2. Configuration changes needed
3. Commands to execute
4. Validation to confirm fix

**Prevention**:
- Configuration recommendations
- Monitoring alerts to set up
- Best practices to follow

**Escalation**:
- When to escalate to Azure Support
- Information to gather before escalating

---

### 2. Resource-Specific Common Issues

#### App Service / Function App Issues:
- HTTP 502/503 errors
- High CPU/memory usage
- Slow response times
- Deployment failures
- Connection timeout to dependencies

#### SQL Database Issues:
- Connection timeouts
- High DTU/CPU usage
- Blocked queries
- Geo-replication lag
- Failed backups

#### Storage Account Issues:
- Access denied errors
- Throttling (503 errors)
- Slow upload/download
- Blob not found errors

#### Virtual Network Issues:
- Connectivity failures between subnets
- NSG blocking traffic
- Private endpoint not resolving
- VPN tunnel down

#### Key Vault Issues:
- Access denied to secrets
- Certificate renewal failures
- Firewall blocking access

### 3. Troubleshooting Runbooks

Create step-by-step runbooks for:

#### Runbook 1: Service Outage Response
1. **Identify scope**: Which service/resource is down?
2. **Check health**: Azure Service Health, Resource Health
3. **Review logs**: Application Insights, Log Analytics
4. **Check dependencies**: Are downstream services healthy?
5. **Immediate mitigation**: Restart, failover, scale up
6. **Communication**: Update status page, notify stakeholders
7. **Root cause analysis**: Once resolved, document learnings

#### Runbook 2: Performance Degradation
1. **Establish baseline**: What is normal performance?
2. **Collect metrics**: CPU, memory, network, database DTU
3. **Review recent changes**: Deployments, config changes
4. **Analyze slow requests**: APM traces, SQL query plans
5. **Apply fixes**: Optimize code, add caching, scale resources
6. **Validate improvement**: Compare before/after metrics

#### Runbook 3: High Error Rate
1. **Identify error types**: HTTP 4xx vs 5xx, exception types
2. **Check error logs**: Stack traces, error messages
3. **Determine pattern**: Specific endpoints, time-based, user-based
4. **Test reproduction**: Can you reproduce the error?
5. **Fix and deploy**: Code fix or config change
6. **Monitor error rate**: Confirm resolution

### 4. Diagnostic Tools & Commands

#### Azure CLI Commands
``bash
# Get resource health
az resource show --ids /subscriptions/.../resourceGroups/rg-contoso-patient-portal-dev

# View activity log
az monitor activity-log list --resource-group rg-contoso-patient-portal-dev --max-events 20

# Check service health
az rest --method get --url 'https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.ResourceHealth/availabilityStatuses?api-version=2022-10-01'
``n
#### KQL Queries for Log Analytics
``kql
// Recent errors (last 24 hours)
AzureDiagnostics
| where TimeGenerated > ago(24h)
| where Level == 'Error' or Level == 'Critical'
| summarize count() by Resource, Category
| order by count_ desc

// Performance anomalies
AzureMetrics
| where TimeGenerated > ago(1h)
| where MetricName in ('CpuPercentage', 'MemoryPercentage')
| summarize avg(Average) by Resource, MetricName, bin(TimeGenerated, 5m)
| where avg_Average > 80
``n
### 5. Emergency Contacts & Escalation

**Level 1 Support**: Application team (on-call rotation)
**Level 2 Support**: Platform/infrastructure team
**Level 3 Support**: Azure Support (via Azure Portal)

**Azure Support Ticket**:
- Portal: Support + Help > New support request
- Gather: Resource IDs, correlation IDs, timestamps, error messages

### 6. Post-Incident Review Template

After resolving major incidents, document:
- **Incident timeline**: When detected, when resolved
- **Root cause**: What caused the issue?
- **Impact**: Users affected, duration, business impact
- **Resolution**: What fixed it?
- **Action items**: How do we prevent recurrence?

## Output Format
- Use **Markdown** with clear headers
- Include **code blocks** for commands and queries
- Use **checklists** for step-by-step procedures
- Add **warning boxes** for critical steps
- Include **decision trees** for complex troubleshooting

## Guidelines
- Assume audience is on-call engineers under pressure
- Make steps **clear, concise, and actionable**
- Include **time estimates** for each step
- Highlight **quick wins** vs deep investigations
- Focus on **common issues** (80/20 rule)

---

Please generate a comprehensive troubleshooting guide following this structure.
