name: Markdown Validation

on:
  push:
    branches: [main]
    paths:
      - '**/*.md'
  pull_request:
    branches: [main]
    paths:
      - '**/*.md'
  schedule:
    - cron: '0 1 * * *'  # Run daily at 01:00 UTC
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  issues: write

jobs:
  validate-markdown:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdown validation
        id: markdownlint
        continue-on-error: true
        run: |
          echo "::group::Validating markdown files"
          OUTPUT=$(markdownlint '**/*.md' --ignore node_modules --config .markdownlint.json 2>&1) || true
          EXIT_CODE=$?
          echo "$OUTPUT"
          echo "::endgroup::"
          # Save output for issue creation
          {
            echo "lint_output<<EOF"
            echo "$OUTPUT"
            echo "EOF"
            echo "exit_code=$EXIT_CODE"
          } >> "$GITHUB_OUTPUT"
          # Re-run to get the actual exit code for the step
          markdownlint '**/*.md' --ignore node_modules --config .markdownlint.json

      - name: Check line endings
        run: |
          echo "::group::Checking line endings (should all be LF)"
          if git ls-files --eol | grep 'w/crlf'; then
            echo "::error::Found files with CRLF line endings. Run 'git add --renormalize .' to fix."
            exit 1
          else
            echo "âœ“ All files use LF line endings"
          fi
          echo "::endgroup::"

      - name: Check for existing issue
        id: check_issue
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && steps.markdownlint.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const issueTitle = `Automated markdownlint problems [${today}]`;

            // Search for existing open issues with the same title
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'markdownlint'
            });

            const existingIssue = issues.find(issue => issue.title === issueTitle);
            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              core.setOutput('exists', 'true');
              core.setOutput('issue_number', existingIssue.number);
            } else {
              console.log('No existing issue found for today');
              core.setOutput('exists', 'false');
            }

      - name: Create issue for markdownlint errors
        if: (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch') && steps.markdownlint.outcome == 'failure' && steps.check_issue.outputs.exists == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const lintOutput = `${{ steps.markdownlint.outputs.lint_output }}`;

            const issueBody = [
              '## Automated Markdown Lint Report',
              '',
              'This issue was automatically created by the nightly markdown validation workflow.',
              '',
              '### Errors Found',
              '',
              '```',
              lintOutput,
              '```',
              '',
              '### How to Fix',
              '',
              '1. Review the errors listed above',
              '2. Fix the markdown issues in the affected files',
              '3. Run `markdownlint \'**/*.md\' --ignore node_modules --config .markdownlint.json` locally to verify fixes',
              '4. Commit and push changes',
              '',
              '---',
              `*This issue was automatically generated on ${today} by the [Markdown Validation workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`
            ].join('\n');

            // Try to create issue with copilot assignee, fall back to no assignee if it fails
            try {
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Automated markdownlint problems [${today}]`,
                body: issueBody,
                labels: ['markdownlint', 'automated'],
                assignees: ['copilot']
              });
              console.log(`Created issue #${issue.number}: ${issue.html_url}`);
            } catch (error) {
              // If assignment fails, create issue without assignee
              console.log(`Warning: Could not assign to copilot, creating issue without assignee: ${error.message}`);
              const { data: issue } = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Automated markdownlint problems [${today}]`,
                body: issueBody,
                labels: ['markdownlint', 'automated']
              });
              console.log(`Created issue #${issue.number}: ${issue.html_url}`);
            }
